---
title: "INFO523-Term Project Part 2 - Group 4"
author: "Sierra Das, Shanna Barrett, Kaelah Fordyce (Lead)"
output: html_document
date: "`r Sys.Date()`"
---

### Project 2 Instructions 
Project Part 2: Data Preprocessing
Learning objectives:

1. To examine missing data and evaluate different approaches to deal with missing data. Removing or imputing missing data from a dataset is always a risky step as it may skew the data distribution. Students need to provide sufficient rationale when they remove or impute missing data. 
2. To test for correlation or independence between categorical variables and between continuous variables.  Detecting relationships between variables may be interesting findings on its own, and it can also be useful to identify redundant attributes in a dataset. 
3. To concisely summarize the main findings that are supported by the analyses.  
4. Students are expected to select appropriate methods for their analysis and objectively apply the methods so that the analysis and results do not contain major flaws or biases.  When unexpected results are obtained, use another method to verify the findings. 

Dataset:

Use the police shooting data v2 provided to you. Note this is the dataset used for the entire project.  it is not the dataset used in the Instructor's demo. To locate the dataset in d2l, see  https://www.screencast.com/t/7xKMOHEQ.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Each team member completed the entire assignment independently. Once everybody had the assignment completed, each team member presented their codes and findings to the group, and we worked together to consolidate the final project for submission.

#import libraries needed to complete tasks 
library("dplyr")
library("ggplot2")
library("psych")
library("tidyr")
library("huxtable")
library("tidyverse")
library("lubridate")
library("discretization")
library("corrplot")
```

```{r}
#import police shooting data
data_raw <- read.csv('/Users/kaelahfordyce/Documents/skool/INFO523-DataMining_SP24/datasets/fatal-police-shootings-data1.csv')

```

# Task 1

1. Describe the police shooting data set by filling out the table below (follow the 'age' example) and comment on the possible ways to deal with the missing data (e.g. is this possible to impute the missing values? or should the attribute be excluded in subsequent analyses).  Hint: missing data may be represented in multiple ways in one dataset 

### Task 1 - Part 1
Create a data frame with the attribute names, definitions, and data types as presented in the README file
```{r}
##create data frame with the raw column definitions from the README file, with a bit of cleanup to break up each variable into separate rows
definitions <- data.frame(A = c("`id`| A unique identifier for each fatal police shooting incident.| number| `2`",
                                "`date`| The date of the fatal shooting.| string <br> `YYYY-MM-DD`| `2020-06-25`",
                                "`body_camera`| Whether news reports have indicated an officer was wearing a body camera and it may have recorded some portion of the incident.| boolean `True`/ `False`| `True`",
                                "`city`| The municipality where the fatal shooting took place| string | `New Orleans`",
                                "`county`| County where the fatal shooting took plce. | string | `Brown`",
                                "`state`| The two-letter postal code abbreviation for the state in which the fatal shooting took place.| string|`LA`",
                                "`latitude`| The latitude location of the shooting expressed as WGS84 coordinates, geocoded from addresses. Please note that the precision and accuracy of incident coordinates varies depending on the precision of the input address which is often only available at the block level. | decimal number |`47.246826`",
                                "`longitude`| The longitude location of the shooting expressed as WGS84 coordinates, geocoded from addresses.| decimal number|`-123.121592`",
                                "`location_precision`| Indicates the precision level of the input which was geocoded to generate the coordinate data. | string <br><br> options:<br>-`address`: Specific address, eg: `1 Main St.`<br>-`poi_small`: A small point of interest, eg: `Jim's Pizza`.<br>-`intersection`: Intersection of two roads, eg: `6th Avenue and Izabel Street` <br>-`poi_large`: A large point of interest, eg: `Central Mall`. <br>-`block`: Block level address, eg: `100 Block of Main St.`<br>-`road`: Road name, eg: `Glenwood Drive` <br>-`highway`: Highway name, eg: `Georgia Highway 11`<br>-`not_available`: Location was entered before current methodology was established. | `block`",
                                "`name`| The name of the victim.| string| `John Doe`",
                                "`age`| The age of the victim at the time of the incident.| number| `23`",
                                "`gender`| The gender of the victim. The Post identifies victims by the gender they identified with if reports indicate that it differs from their biological sex.| string <br><br> options:<br>- `male`<br>- `female`<br>- `non-binary`<br>- `--`: Unknown| `male`",
                                "`race`| The race and ethnicity (where known) of the victim. May contain multiple values to accommodate for multi-racial or several racial and ethnic identifications. Race has been included where news accounts, police reports or other official documents specifically mention a victimâ€™s race or where researchers were able to make a visual determination on racial identification through photos. With the introduction of v2 of the database, the Post has began tracking multiple race and ethnicity designations; prior to 2021, only one race or ethnicity was assigned to most victims. | string <br><br> options:<br>- `W`: White<br>- `B`: Black<br>- `A`: Asian heritage<br>- `N`: Native American<br>- `H`: Hispanic<br>- `O`: Other<br>- `--`: Unknown| `B;H`",
                                "`race_source`| Sourcing methodology for victim race data. | string <br><br> options: <br>- `public_record`<br>- `clip`<br>- `photo`<br>- `other`<br>- `not_available`: Indicates older records which have `race` populated but The Post does not have details on the methodology because it was collected before the current structure was introduced. <br>- `undetermined`: When The Post's race research avenues have been exhausted and race is still unknown, this indicates that race is still unknown, but research is complete.<br>- `null`| `public_record`",
                                "`was_mental_illness_related` | Whether news reports have indicated the victim had a history of mental health issues, expressed suicidal intentions or was experiencing mental distress at the time of the shooting.| boolean `True`/`False`| `True`",
                                "`threat_type` | Actions the victim took leading up to the fatal shooting.| string <br><br> options: <br>- `shoot`: The victim fired a weapon.<br>- `point` :The victim pointed a weapon at another individual.<br>- `attack`: The victim attacked with other weapons or physical force.<br>- `threat`: The victim had some kind of weapon visible to the officers on the scene.<br>- `move`: The victim was moving in a threatening way.<br>- `flee`: The victim was fleeing (see `flee_status`)<br>- `accident`:  :question: <br>- `undetermined`: The threat type could not be determined from available evidence| `point`",
                                "`armed_with`| What, if anything, was the victim armed with per federal classifications based on NIBRS, the national incident-level crime reporting system. These categories are roughly reflected in local police data and forms. A NIBRS manual is can be found here (see values for data element Type Weapon/Force involved, on PDF page 104/report page 94).| string <br><br> options: <br>- `gun`: A firearm, handgun, shotgun, or other firearm<br>- `knife` : A knife or other cutting instrument (razors, hatches, axes, cleavers, scissors, broken bottles, ice picks, etc.)<br>- `blunt_object`: A blunt object (baseball bats, the butt of a handgun, clubs, bricks, tire irons, bottles, etc.)<br>- `other`: Any other weapon (BB guns, pellet guns, Tasers, pepper spray, stun guns, etc.)<br>- `replica`: A toy weapon, replica, or other non-functional firearm.<br>- `undetermined`: Whether the victim had a weapon could not be determined from available evidence.<br>- `unknown`: There was a weapon involved, but we do not know what kind.<br>- `unarmed`: The victim had no weapon according to available evidence.<br>- `vehicle`: A motor vehicle or vessel. | `gun;knife`",
                                "`flee_status`| How, if at all, was the victim moving relative to officers leading up to the shooting.| string <br><br> options: <br>- `foot` : On foot<br>- `car` : Via car <br>- `other`: Via another vehicle<br>- `not`: Not fleeing| `foot'",
                                "`agency_ids`| List of agency ids associated with the death record. | string | `1;2`"
                                )
                          )

##update data frame to split the information into separate columns by the pipe delimiter in the original README file
definitions <- definitions %>%
  separate(col=A, into=c("attribute","definition","data_type","sample_values"), sep="\\s*\\|\\s*", fill="right")

##remove the sample_values field, since it was not included in the assignment template
definitions <- select(definitions, -sample_values)

##remove characters ` and * from the attribute column to have a clean value for the attribute names (removing extraneous characters that were included in the raw README file for this field)
definitions$attribute <- gsub("`","",as.character(definitions$attribute))
definitions$attribute <- gsub("*","",as.character(definitions$attribute))

##remove everything after the first < character in the data_type column to have a clean value for only the data type (removing extraneous characters/examples that were included in the raw README file for this field)
definitions$data_type <- sub("<.*", "", definitions$data_type)
```

### Task 1 - Part 2
Analyze the raw data file to determine quantity of missing data
```{r}
#view a summary of the dataset
str(data_raw)

#examine missing data
## 1467 out of 8720 rows have some missing value (blank or NA)
missing_records <- filter(data_raw, !complete.cases(data_raw))

#create a data frame showing the counts of NA and blank cells by column
missing_columns <- data.frame(
  column_name = c("id", "date", "threat_type", "flee_status", "armed_with", "city", "county", "state", "latitude", "longitude", "location_precision", "name", "age", "gender", "race", "race_source", "was_mental_illness_related", "body_camera", "agency_ids"),
  na_record_ct = colSums(is.na(data_raw)), 
  blank_record_ct = c(sum(data_raw$id==""),
                      sum(data_raw$date==""),
                      sum(data_raw$threat_type==""),
                      sum(data_raw$flee_status==""),
                      sum(data_raw$armed_with==""),
                      sum(data_raw$city==""),
                      sum(data_raw$county==""),
                      sum(data_raw$state==""),
                      sum(data_raw$latitude==""),
                      sum(data_raw$longitude==""),
                      sum(data_raw$location_precision==""),
                      sum(data_raw$name==""),
                      sum(data_raw$age==""),
                      sum(data_raw$gender==""),
                      sum(data_raw$race==""),
                      sum(data_raw$race_source==""),
                      sum(data_raw$was_mental_illness_related==""),
                      sum(data_raw$body_camera==""),
                      sum(data_raw$agency_ids=="")
                      )
  )

#replace na values in the counts with 0 for easier addition of the two columns 
missing_columns[is.na(missing_columns)] <- 0

#sum the na and blank column counts to get a full count of missing records by column
missing_columns$missing_record_total = missing_columns$na_record_ct + missing_columns$blank_record_ct

#merge the definitions table (created from the README file) and missing_columns table where the attribute field matches the column name
missing_data_details <- merge(definitions, missing_columns, by.x = "attribute", by.y = "column_name")

#create a new field called %_of_missing_data, calculated as the total missing record count divided by total number of records in the dataset
missing_data_details$"%_of_missing_data" <- (missing_data_details$missing_record_total / 8720)*100

#select only the columns needed for the task 1 template
missing_data_details <- subset(missing_data_details, select=c("attribute", "definition", "data_type", "%_of_missing_data"))

#review the values in missing data columns to determine how to fill or remove
unique_threat_types <- data_raw %>%
  group_by(threat_type) %>%
  summarise(count = n_distinct(id))
print(unique_threat_types)

unique_flee_statuses <- data_raw %>%  
  group_by(flee_status) %>% 
  summarise(count = n_distinct(id))
print(unique_flee_statuses)

unique_armed_with <- data_raw %>%  
  group_by(armed_with) %>% 
  summarise(count = n_distinct(id))
print(unique_armed_with)

unique_cities <- data_raw %>%  
  group_by(city) %>% 
  summarise(count = n_distinct(id))
print(unique_cities)

unique_location_precision <- data_raw %>%  
  group_by(location_precision) %>% 
  summarise(count = n_distinct(id))
print(unique_location_precision)

unique_age <- data_raw %>%  
  group_by(age) %>% 
  summarise(count = n_distinct(id))
print(unique_age)

unique_gender <- data_raw %>%  
  group_by(gender) %>% 
  summarise(count = n_distinct(id))
print(unique_gender)

unique_race <- data_raw %>%  
  group_by(race) %>% 
  summarise(count = n_distinct(id))
print(unique_race)

unique_race_source <- data_raw %>%  
  group_by(race_source) %>% 
  summarise(count = n_distinct(id))
print(unique_race_source)

unique_state <- data_raw %>%  
  group_by(state) %>% 
  summarise(count = n_distinct(id))
print(unique_state)
```

### Task 1 - Part 3
Brainstorm options for handling missing data for each field and add notes to the data frame 
```{r}
#create a new field to document how to handle missing values for each column 
missing_data_details$missing_values_handling <- c(
  ifelse(missing_data_details$attribute=="id","N/A-No missing data",
  ifelse(missing_data_details$attribute=="date","N/A-No missing data",
  ifelse(missing_data_details$attribute=="threat_type","Replace missing data with value 'undetermined'",
  ifelse(missing_data_details$attribute=="flee_status","Replace missing data with value 'undetermined'", 
  ifelse(missing_data_details$attribute=="armed_with","Replace missing data with value 'undetermined'",
  ifelse(missing_data_details$attribute=="city","Since there is only a small percentage of records missing data from the city variable, those records with missing data could be removed from analyses that include this attribute. Alternatively, the missing data could be replaced with the value 'undetermined', or if extremely necessary, try to assume the city based on either the county and/or latitude/longitude (if available).", 
  ifelse(missing_data_details$attribute=="county","Missing data values could be assumed/calculated based on city and/or latitude/longitude (if available), or since over half of the records have data missing for this field, exclude this variable from analyses", 
  ifelse(missing_data_details$attribute=="state","N/A-No missing data",
  ifelse(missing_data_details$attribute=="latitude","Remove records with nulls, or if city/state given you could estimate using the coordinates of the center of the city",
  ifelse(missing_data_details$attribute=="longitude","Remove records with nulls, or if city/state given you could estimate using the coordinates of the center of the city",
  ifelse(missing_data_details$attribute=="location_precision","Replace missing data with value not_available",
  ifelse(missing_data_details$attribute=="name","Remove this field from analyses-PI should not typically be used in modeling",
  ifelse(missing_data_details$attribute=="age","Use regression to determine average/median age and impute values based on that, or update value to unknown, or remove missing records from analyses",
  ifelse(missing_data_details$attribute=="gender","There is not a large percentage missing, so missing values could be updated to  'undetermined' or 'unknown', or remove records missing data from analyses",
  ifelse(missing_data_details$attribute=="race","Replace missing data with value 'U' for undetermined",
  ifelse(missing_data_details$attribute=="race_source","Replace missing data with value 'not_available'",
  ifelse(missing_data_details$attribute=="was_mental_illness_related","N/A-No missing data",
  ifelse(missing_data_details$attribute=="body_camera","N/A-No missing data",
  ifelse(missing_data_details$attribute=="agency_ids","If needed for analysis, remove the 2 records with missing data",
"Not yet determind"))))))))))))))))))))

missing_data_details <- as_tibble(missing_data_details)
print(missing_data_details)

```

# Task 2

2. In the in-class demo, the Pearson Correlation between state incident count and state population was examined. We found that the number of incident counts in a state is strongly and positively (linearly) correlated with the state population.  Are you interested in examining relationships btw some other variables? For example,  is the age of the individual associated with the weapon the individual tends to possess at the time of a shooting incident? Perform two such analyses, one using the Pearson Correlation Coefficient analysis and the other using Chi-Squared analysis or CramÃ©r's V. Choose the variables of interest to you, perform necessary data preprocessing steps, select the appropriate correlation method, and report the findings.   Hint: use appropriate data types.

### Task 2 - Part 1
Pearson Correlation Coefficient analysis
(best for continuous variables)
```{r}
#manipulate data from the raw file into a format acceptable for the correlation analysis (i.e. alter categorical variables to binary/numeric, and remove empty/na values)
data_corrplot <- data_raw %>%
  select(age, date, latitude, longitude, was_mental_illness_related, flee_status, gender, armed_with) %>%
  filter(
    !is.na(age) & age != "",
    !is.na(latitude) & latitude != "",
    !is.na(longitude) & longitude != "",
    !is.na(gender) & gender != ""
    ) %>%
  mutate(flee_status = as.numeric(ifelse(flee_status == "not", 0, 1)), 
         armed_with = as.numeric(ifelse(armed_with == "unarmed", 0, 1)),
         gender = as.numeric(ifelse(gender == "female", 0, 
                                    ifelse(gender == "male", 1, 
                                           3))), 
         was_mental_illness_related = as.numeric(ifelse(was_mental_illness_related == "False", 0, 1)), 
         date = as.numeric(as.Date(date)) #convert dates to R's internal numeric representation
         ) %>%
  rename(mental_health = was_mental_illness_related)

#Converted flee_status, armed_with, and was_mental_health_related to binary 0's and 1's in order to be able to use them for the correlation analysis. This is reasonable as it changes the question of each flee_status from if and what type of fleeing there was to if the victim fled or not. We are looking at the broader correlation of whether someone fled or not versus their method. The same concept can be applied to armed_with and was_mental_health related. 

#confirm the categorical variable values are now binary (either 0 or 1)
unique(data_corrplot$armed_with)
unique(data_corrplot$flee_status)
unique(data_corrplot$mental_health)
unique(data_corrplot$gender)

#calculate correlation matrix to identify variables that have some relationship
correlation_matrix <- cor(data_corrplot)

#plot the correlation matrix for easier visual interpretability  
corrplot(correlation_matrix, 
         method = "circle", 
         tl.pos = "d", 
         cl.pos = "n", 
         addCoef.col = "black"
         )

#Based on the correlation matrix, there seems to be a correlation between the following variables: age & mental health; age & flee status; date & mental health; date & flee status; latitude & longitude; and mental health & flee status. We selected date & flee status and flee status & mental health to analyze further, since these variables had the largest correlation coefficients between them.

#date & flee status
cor.test(data_corrplot$date, data_corrplot$flee_status)
#The p-value is < 0.05, which means there is a statistically significant correlation between date and flee status in the dataset, but the correlation coefficient of ~0.23 indicates the correlation is weak. The positive correlation coefficient value suggests that as the date value increases, the flee status number tends to increase slightly as well. The 95% confidence interval for the correlation coefficient is between 0.21 and 0.25, which means we can be 95% confident that the correlation between date and flee status falls within this range.

#flee status & mental health
cor.test(data_corrplot$flee_status, data_corrplot$mental_health)
#The p-value is < 0.05, which means there is a statistically significant correlation between flee status and mental health in the dataset, but the correlation coefficient of ~0.21 indicates the correlation is weak. The negative correlation coefficient value suggests that as the flee status value increases, the mental health number tends decrease slightly. Given how these categorical variables were converted in this data, this would seem to suggest that if the victim fled, it was less likely to be mental health related. The 95% confidence interval for the correlation coefficient is between -0.23 and -0.19, which means we can be 95% confident that the correlation between flee status and menthal health falls within this range.

```

### Task 2 - Part 2
Chi-squared analysis
(best for categorical variables)
```{r}
#select the variables of interest and manipulate data from the raw file into a format acceptable for the chi-squared analysis
data_chi <- data_raw %>%
  select(was_mental_illness_related, flee_status, gender, armed_with, threat_type, date, state) %>%
  filter(!is.na(gender) & gender != "") %>%
  mutate(flee_status = ifelse(flee_status == "", "undetermined", flee_status), 
         armed_with = ifelse(armed_with == "", "undetermined", armed_with), 
         threat_type = ifelse(threat_type == "", "undetermined", threat_type),
         month = substr(date,6,7)
         ) %>%
  rename(mental_health = was_mental_illness_related)

#create a data frame to store chi-squared results to compare the results for multiple variables analyzed
chi_squared_results <- data.frame()

#run chi-squared test for pairs of interest variables, and add results to the dataframe

#mental health vs flee status
chi1 <- chisq.test(data_chi$mental_health, data_chi$flee_status)
chi_squared_results <- rbind(chi_squared_results, c("mental_health", "flee_status", chi1$statistic, chi1$p.value))

#mental health vs gender
chi2 <- chisq.test(data_chi$mental_health, data_chi$gender)
chi_squared_results <- rbind(chi_squared_results, c("mental_health", "gender", chi2$statistic, chi2$p.value))

#mental health vs weapon
chi3 <- chisq.test(data_chi$mental_health, data_chi$armed_with)
chi_squared_results <- rbind(chi_squared_results, c("mental_health", "armed_with", chi3$statistic, chi3$p.value))

#mental health vs threat type
chi4 <- chisq.test(data_chi$mental_health, data_chi$threat_type)
chi_squared_results <- rbind(chi_squared_results, c("mental_health", "threat_type", chi4$statistic, chi4$p.value))

#mental health vs state
chi5 <- chisq.test(data_chi$mental_health, data_chi$state)
chi_squared_results <- rbind(chi_squared_results, c("mental_health", "state", chi5$statistic, chi5$p.value))

#mental health vs month
chi6 <- chisq.test(data_chi$mental_health, data_chi$month)
chi_squared_results <- rbind(chi_squared_results, c("mental_health", "month", chi6$statistic, chi6$p.value))

#set column names
colnames(chi_squared_results) <- c("Variable1", "Variable2", "ChiSquareStatistic", "P_Value")

#display the results
print(chi_squared_results)


#Based on the chi-squared test results, mental health has a statistically significant correlation with flee_status, gender, armed_with, threat_type, and state in the dataset. This is shown by the p-values < 0.05. Out of the variables tested, only month did not show statistically significant correlation (p-value is > 0.05). Based on the chi-square statistic, mental health has the strongest relationship with flee_status, followed by armed_with.

```